<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <!-- <button id="create">第一步：创建钱包</button>
    <button id="run_next">第二步：继续运行用例</button> -->

    <div id="text" class="text-box">这是一段文本显示框</div>

    <script src="./nulink-sdk.js"></script>

    <script>
      //mock the android bridge
      const bridge = (window.__JSHOST = window);

      console.log('【---NUSDK----】', NUSDK);
      document.getElementById('text').textContent = NUSDK;
      // console.log('【---NUSDK.getPolicysGasFee----】', NUSDK.getPolicysGasFee)
      // console.log('【---NUSDK.Buffer----】', NUSDK.Buffer)
      // console.log('【---NUSDK.BigNumber----】', NUSDK.BigNumber)
      // //console.log('【---Web3----】', Web3)

      // ----------------------Global variable area start ------------------------
      // const password = '1';
      // let nuLinkHDWallet;
      // let mnemonic;
      // let accountAlice;

      const sleep = async (ms) => {
        return new Promise((resolve) => setTimeout(resolve, ms));
      };

      const asyncInit = async () => {
        try {
          const clientId = '593689189003333';
          await NUSDK.init(clientId);
          console.log('init finish');
          document.getElementById('text').textContent = 'initialization complete';
          return true;
        } catch (error) {
          document.getElementById('text').textContent = 'initialization failed';
          throw error;
        }
        return false;
      };
      // ----------------------Global variable area end ------------------------

      // document.addEventListener('DOMContentLoaded', () => {
      //   //async function: init
      //   asyncInit();  // Call after the DOM has fully loaded
      //   });
      (async () => {
        const result = await asyncInit();
        console.log('init result:', result);

        //mock the message handling function (process messages received from Android)
        window.addEventListener('message', function (e) {
          let data = {};
          // debugger
          if (e.origin !== 'null') {
            //Verify the source address of the message
              return;
            }
            
          try {
            data = JSON.parse(e.data);
            if(data?.data?.code !== undefined && data?.data?.msg !== undefined)
          {
            //console.log("response from android bridge: ", data.data);
          }
          else{
            window.__jMessage(String(data.id), String(data.method), data.data);
          }
            
          } catch (error) {

            data = e.data;
            //console.log("message handler error: ", error);
            // console.log("unknown message data: ", data);
            //debugger
          }
        });

        
        // // console.log("SDK: [test] send message to app");
        // bridge.postMessage(JSON.stringify({ id: "1", method: 'test', data: { message: 'this is a test message' } }), '/');
        // sleep(1000)
        // console.log("SDK: [generateMnemonic] send message to app");
        bridge.postMessage(JSON.stringify({ id: "2", method: 'generateMnemonic', data: {} }), '/');
        sleep(1000)
        const password = '1';
        bridge.postMessage(JSON.stringify({ id: "3", method: 'createWallet', data: {"password": password, "mnemonic": "buffalo capable tomato office riot slam finger spirit lesson lucky debate volcano"} }), '/');
        sleep(3000)
        bridge.postMessage(JSON.stringify({ id: "4", method: 'getAccountInfo', data: {"password": password} }), '/');

      })();
    </script>
  </body>
</html>
