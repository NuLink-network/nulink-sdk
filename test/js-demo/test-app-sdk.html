<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <!-- <button id="create">第一步：创建钱包</button>
    <button id="run_next">第二步：继续运行用例</button> -->

    <div id="text" class="text-box">这是一段文本显示框</div>

    <script src="./nulink-sdk.js"></script>

    <script>
      // Note: 
      //need .env* change config to: REACT_APP_STORAGE=localstorage
      console.log("need .env* change config to: REACT_APP_STORAGE=localstorage");
      
      //mock the android bridge
      const bridge = (window.__JSHOST = window);

      console.log('【---NUSDK----】', NUSDK);
      document.getElementById('text').textContent = NUSDK;
      // console.log('【---NUSDK.getPolicysGasFee----】', NUSDK.getPolicysGasFee)
      // console.log('【---NUSDK.Buffer----】', NUSDK.Buffer)
      // console.log('【---NUSDK.BigNumber----】', NUSDK.BigNumber)
      // //console.log('【---Web3----】', Web3)

      // ----------------------Global variable area start ------------------------
      // const password = '1';
      // let nuLinkHDWallet;
      // let mnemonic;
      // let accountAlice;

      const sleep = async (ms) => {
        return new Promise((resolve) => setTimeout(resolve, ms));
      };

      const asyncInit = async () => {
        try {
          const clientId = '593689189003333';
          await NUSDK.init(clientId);
          
          const dataCallback = {
            setData: NUSDK.setIPFSData,
            getData: NUSDK.getIPFSData
          };

          //Set the external storage used by the Pre process to IPFS (for example, encrypted files uploaded by users will be stored in this storage, and users can customize the storage).
          NUSDK.StorageManager.setDataCallback(dataCallback);
          
          console.log('init finish');
          document.getElementById('text').textContent = 'initialization complete';
          return true;
        } catch (error) {
          document.getElementById('text').textContent = 'initialization failed';
          throw error;
        }
        return false;
      };

      // ----------------------Global variable area end ------------------------

      // document.addEventListener('DOMContentLoaded', () => {
      //   //async function: init
      //   asyncInit();  // Call after the DOM has fully loaded
      //   });
      (async () => {
        const result = await asyncInit();
        console.log('init result:', result);

        //mock the message handling function (process messages received from Android)
        window.addEventListener('message', function (e) {
          let data = {};
          // debugger
          if (e.origin !== 'null') {
            //Verify the source address of the message
              return;
            }
            
          try {
            data = JSON.parse(e.data);
            if(data?.data?.code !== undefined && data?.data?.msg !== undefined)
          {
            //console.log("response from android bridge: ", data.data);
          }
          else{
            window.__jMessage(String(data.id), String(data.method), data.data);
          }
            
          } catch (error) {

            data = e.data;
            //console.log("message handler error: ", error);
            // console.log("unknown message data: ", data);
            //debugger
          }
        });
        
        const password = '1';
        
        // // console.log("SDK: [test] send message to app");
        // bridge.postMessage(JSON.stringify({ id: "1", method: 'test', data: { message: 'this is a test message' } }), '/');
        // await sleep(1000)
        // console.log("SDK: [generateMnemonic] send message to app");

        bridge.postMessage(JSON.stringify({ id: "2", method: 'generateMnemonic', data: {} }), '/');
        await sleep(1000)

        // bridge.postMessage(JSON.stringify({ id: "3", method: 'createWallet', data: {"password": password, "mnemonic": "buffalo capable tomato office riot slam finger spirit lesson lucky debate volcano"} }), '/');
        // await sleep(3000)
        bridge.postMessage(JSON.stringify({ id: "4", method: 'getAccountInfo', data: {"password": password} }), '/');
        await sleep(1000)
        bridge.postMessage(JSON.stringify({ id: "5", method: 'restoreWallet', data: {"newPassword": password, "mnemonic": "buffalo capable tomato office riot slam finger spirit lesson lucky debate volcano"} }), '/');
        await sleep(3000)
        bridge.postMessage(JSON.stringify({ id: "6", method: 'setRpcUrl', data: {"rpcUrl": "https://data-seed-prebsc-1-s2.bnbchain.org:8545"} }), '/');
        await sleep(1000)
        
        const plainText =
          '# encoding=utf-8\n\nimport requests\nimport json\nfrom config.web3_provider import W3\n\n\'\'\'\n    Aaveçå¬åçº¦ååºçäºä»¶å¹¶æ¥æ¾å¯æ¸ ç®è´¦æ·\n\'\'\'\n\n\nclass ListenEvent:\n    def __init__(self, chain_type, scan_address):\n        self.web3 = W3(chain_type=chain_type, num=3)\n        self.chain_type = chain_type\n        self.scan_address = scan_address\n        self.event_topic = "0xc6a898309e823ee50bac64e45ca8adba6690e99e7841c45d754e2a38e9019d9b"\n        self.api = "https://api.aurorascan.dev/api"\n        self.pool_contract = self.web3.load_contract("AAVEPool", self.scan_address)\n        self.variable_debt_token_list = [\n            ["variable-debt-usdc", "0x8b225BF698eFd7fA4A9E3FB10424711739304ACa"],\n            ["variable-debt-usdt", "0xc0D1Be1C87B56b72Db03800726AAB7e61AE9AaC7"],\n            ["variable-debt-wnear", "0xaa0E01C05a6361fe8aD037A4b142f633e418B251"],\n            ["variable-debt-weth", "0x541996252ECcF5047671302CaaFf25b4312d482e"],\n            ["variable-debt-dai", "0x1c2E8486e2aF6B168a7985Dcec3309780bEb5F25"],\n            ["variable-debt-wbtc", "0x90eCe2301214b2B86cB77326232e2b6D4b373d7B"]\n        ]\n        self.collateral_token_list = [\n            ["aUsdc", "0x0a88079323d2cCf5f83014a5351058553439499C"],\n            ["aUsdt", "0xD55f46Df9C67297619CD6b254167F5Ed1F34998e"],\n            ["aWnear", "0x6f610C3Ff9e64625ae29C2DA7663Ec100A9433bE"],\n            ["aWeth", "0x935ef78719d55b3a8a53d0ac9494a94658843953"],\n            ["aDai", "0xf4d853d5b100A739B03584b0C2840D136b16DDB8"],\n            ["aWbtc", "0x8047CC5397Fdc885ab2EE1DaEE277237ceB4AE50"]\n        ]\n        self.LIQUIDATION_CLOSE_FACTOR_PERCENT = 5000\n\n    def listen_event(self, from_block, to_block):\n        print("from_block %s, to_block %s" % (from_block, to_block))\n        params = {\n            "module": "logs",\n            "action": "getLogs",\n            "fromBlock": from_block,\n            "toBlock": to_block,\n            "address": self.scan_address,\n            "topic0": self.event_topic\n        }\n        res = requests.get(url=self.api, params=params)\n        if res.status_code == 200:\n            content = json.loads(res.content)\n            if content["status"] == "1":\n                log_info_list = content["result"]\n                for log in log_info_list:\n                    topics = log["topics"]\n                    tx_hash = log["transactionHash"]\n                    log_data = log["data"]\n                    reserve = "0x" + topics[1][26:]\n                    user = "0x" + self.web3.get_data_params(log_data, 0)[24:]\n                    user_data = self.pool_contract.functions.getUserAccountData(\n                        self.web3.w3.toChecksumAddress(user)).call()\n                    health = int(user_data[-1]) / (10 ** 18)\n                    need_liquidation = True if health < 1 else False\n                    amount = self.web3.w3.toInt(hexstr=self.web3.get_data_params(log_data, 1))\n                    borrow_rate_mode = self.web3.w3.toInt(hexstr=self.web3.get_data_params(log_data, 2))\n                    borrow_rate = self.web3.w3.toInt(hexstr=self.web3.get_data_params(log_data, 3))\n                    on_behalf_of = "0x" + topics[2][26:]\n                    print("-> tx_hash", tx_hash)\n                    print("     -> reserve", reserve)\n                    print("     -> user", user)\n                    print("     -> onBehalfOf", on_behalf_of)\n                    print("     -> amount", amount)\n                    print("     -> borrowRateMode", borrow_rate_mode)\n                    print("     -> borrowRate", borrow_rate)\n                    print("     -> borrowRate", borrow_rate)\n                    print("     -> health", health)\n                    print("     -> needLiquidation", need_liquidation)\n\n    def get_user_liquidation_info(self, user):\n        print("***** user debt info *****")\n        for debt_token_info in self.variable_debt_token_list:\n            debt_token_name, debt_token = debt_token_info\n            debt_token_contract = self.web3.get_erc20_contract(self.web3.w3.toChecksumAddress(debt_token))\n            token_amount = debt_token_contract.functions.balanceOf(\n                self.web3.w3.toChecksumAddress(user)\n            ).call()\n            max_liquidatable_debt = (token_amount * self.LIQUIDATION_CLOSE_FACTOR_PERCENT + 1e4/2) / 1e4 if token_amount > 0 else 0\n            print(debt_token_name, token_amount, max_liquidatable_debt)\n        print("***** user collateral info *****")\n        for collateral_token_info in self.collateral_token_list:\n            collateral_token_name, collateral_token = collateral_token_info\n            collateral_token_contract = self.web3.get_erc20_contract(self.web3.w3.toChecksumAddress(collateral_token))\n            token_amount = collateral_token_contract.functions.balanceOf(\n                self.web3.w3.toChecksumAddress(user)\n            ).call()\n            print(collateral_token_name, token_amount)\n\n\n\nif __name__ == "__main__":\n    listen_event = ListenEvent("AURORA", "0xa0bC830Ad82D2EAe0bCFd1D6987664A3D9264aFA")\n    # to_block = listen_event.web3.get_latest_block_num()\n    # listen_event.listen_event("62001019", to_block)\n    listen_event.get_user_liquidation_info("0xee0eb9eff81e70b06e8fe181b4a0db924816bc54")\n\n';
        const enc = new TextEncoder(); // always utf-8
        const historyContent /* : Uint8Array */ = enc.encode(plainText);
        
        const dataHexString/* : string */ = NUSDK.arrayBuffer2HexString(historyContent.buffer);
        
          //1.Alice upload file
          const dataList /*: DataInfo[]*/ = [
          {
            label: `history-${NUSDK.nanoid()}.pdf`,
            dataHexString: dataHexString,
            mimetype: 'application/pdf'
          },
          {
            label: `history1-${NUSDK.nanoid()}.pdf`,
            dataHexString: dataHexString,
            mimetype: 'application/pdf'
          },
          {
            label: `history2-${NUSDK.nanoid()}.pdf`,
            dataHexString: dataHexString,
            mimetype: 'application/pdf'
          }
        ];

        //13.Upload dynamic content (post) visible to subscribed users
        bridge.postMessage(JSON.stringify({ id: "6", method: 'publishDataForPaidSubscriberVisible', data: {"password": password, "dataInfoList": dataList} }), '/');
        await sleep(3000)
        //14.Upload dynamic content (post) that requires separate payment each time.
        bridge.postMessage(JSON.stringify({ id: "6", method: 'publishDataForIndividualPaid', data: {"password": password, "dataInfoList": dataList} }), '/');
        await sleep(3000)
        
      })();
      
    </script>
  </body>
</html>
